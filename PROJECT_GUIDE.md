# SumbiTheses Project Guide

## Project Overview

SumbiTheses is a thesis management system designed for educational institutions. It allows administrators, teachers, and students to manage thesis projects, including assignments, reviews, grading, and document management.

## Architecture

This is a **monorepo** structure with the following main components:

```
SumbiTheses/
├── backend/          # Node.js Express API server
├── frontend/         # Next.js React application
├── packages/
│   └── shared-types/ # Shared TypeScript types between frontend and backend
└── docs/            # Documentation files
```

## Technology Stack

### Backend
- **Runtime**: Node.js
- **Framework**: Express.js
- **Language**: TypeScript
- **Database**: PostgreSQL (via Supabase)
- **ORM**: Prisma Client
- **Validation**: Zod
- **API Documentation**: OpenAPI 3.1 (generated from Prisma schema)

### Frontend
- **Framework**: Next.js 15+ (App Router)
- **Language**: TypeScript
- **UI Library**: React
- **Styling**: Tailwind CSS (likely)
- **i18n**: next-intl (internationalization - supports CZ/EN)
- **API Client**: Generated from OpenAPI spec

### Database
- **Provider**: Supabase (PostgreSQL)
- **Auth**: Supabase Auth (with Row Level Security)
- **Storage**: Supabase Storage (for thesis attachments)

### Shared Package
- **`@sumbi/shared-types`**: Shared TypeScript type definitions used by both frontend and backend

## Type System & Conventions

### CRITICAL: Type Usage Rules

#### ✅ DO: Use Shared Types from `@sumbi/shared-types`

**In Controllers and API Layer:**
```typescript
// ✅ CORRECT
import type {
  Project,
  ProjectWithRelations,
  CreateProjectRequest,
  UpdateProjectRequest,
  User
} from '@sumbi/shared-types';

export async function createProject(req: Request, res: Response) {
  // Controller logic
}
```

**In Services:**
```typescript
// ✅ CORRECT
import type { ProjectWithRelations, User } from '@sumbi/shared-types';
import { PrismaClient } from '@prisma/client';

export class ProjectService {
  static async getProjectById(id: bigint): Promise<ProjectWithRelations | null> {
    const project = await prisma.projects.findUnique({
      where: { id: Number(id) },
      include: { /* relations */ }
    });
    return project as any; // Type assertion acceptable here
  }
}
```

#### ❌ DON'T: Use Prisma Types in Controllers

```typescript
// ❌ WRONG - Don't use Prisma types in controllers
import { projects, Prisma } from '@prisma/client';

type Project = projects; // ❌ Wrong
type CreateProject = Prisma.projectsCreateInput; // ❌ Wrong
```

#### ❌ DON'T: Use OpenAPI Generated Types Directly in Backend

```typescript
// ❌ WRONG - OpenAPI types are for documentation only
import type { components } from '../types/api';

type Project = components['schemas']['Project']; // ❌ Wrong
```

### Type System Layers

1. **Database Layer (Prisma Schema)**
   - Location: `backend/prisma/schema.prisma`
   - Purpose: Database schema definition
   - Used by: Prisma Client internally

2. **Shared Types Layer** ⭐ **USE THIS**
   - Location: `packages/shared-types/src/`
   - Purpose: API contract between frontend and backend
   - Used by: Controllers, Services, Frontend components
   - Files:
     - `user.ts` - User-related types
     - `project.ts` - Project-related types
     - `index.ts` - Exports all types

3. **OpenAPI Documentation Layer**
   - Location: `backend/openapi.yaml`
   - Purpose: Auto-generated API documentation
   - Generated by: `npm run generate-types` (uses `openapi-typescript`)
   - Used by: API documentation tools, NOT for application types

### Why This Architecture?

**Separation of Concerns:**
- **Prisma** handles database operations and type safety at the DB layer
- **Shared Types** define the API contract and business logic types
- **OpenAPI** provides documentation for API consumers

**Benefits:**
- Frontend and backend share the same type definitions
- Database implementation details don't leak to the API layer
- Easy to change database/ORM without breaking frontend
- Clear API contracts that are version-controlled
- Type-safe communication between layers

## Database Schema Key Entities

### Core Tables
- **`public_users`** - User accounts (students, teachers, admins)
- **`projects`** - Thesis projects
- **`project_students`** - Many-to-many relationship between projects and students
- **`reviews`** - Review comments from supervisors/opponents
- **`grades`** - Grading records with scale references
- **`years`** - Academic year configurations
- **`scales`** - Grading scale definitions
- **`scale_sets`** - Sets of scales for different roles (supervisor/opponent)
- **`attachments`** - File attachments for projects
- **`external_links`** - External resource links

### Important Field Types
- **IDs**:
  - `BigInt` for numeric IDs (projects, grades, etc.)
  - `String (UUID)` for user IDs (Supabase Auth)
- **Timestamps**: `DateTime` (stored as timestamptz in PostgreSQL)
- **Enums**:
  - `user_roles`: 'admin' | 'teacher' | 'student'
  - `project_role`: 'supervisor' | 'opponent'
  - `status`: 'draft' | 'submitted' | 'locked' | 'public'

## Code Style & Patterns

### Controller Pattern
```typescript
/**
 * JSDoc comment describing what this endpoint does
 */
export async function controllerFunction(req: Request, res: Response) {
  try {
    // 1. Extract and validate parameters
    const id = req.params.id;

    // 2. Call service layer
    const result = await Service.method(id);

    // 3. Handle null/not found cases
    if (!result) {
      return res.status(404).json({ error: 'Not found' });
    }

    // 4. Return success response
    return res.status(200).json(result);
  } catch (error) {
    // 5. Handle errors
    return res.status(500).json({ error: 'Error message' });
  }
}
```

### Service Pattern
```typescript
export class EntityService {
  /**
   * JSDoc comment describing what this method does
   */
  static async methodName(params): Promise<ReturnType> {
    // Use Prisma for database operations
    const result = await prisma.table.operation({
      // Prisma query
    });

    // Cast to shared type
    return result as ReturnType;
  }
}
```

### Naming Conventions
- **Files**: `kebab-case.ts` (e.g., `projects.controller.ts`)
- **Classes**: `PascalCase` (e.g., `ProjectService`)
- **Functions**: `camelCase` (e.g., `getProjectById`)
- **Constants**: `SCREAMING_SNAKE_CASE` (e.g., `MAX_FILE_SIZE`)
- **Types/Interfaces**: `PascalCase` (e.g., `Project`, `CreateProjectRequest`)

## Building and Running

### Backend
```bash
cd backend

# Install dependencies
npm install

# Generate Prisma client and OpenAPI types
npm run generate-types

# Run development server
npm run dev

# Build for production
npm run build

# Run tests (if available)
npm test
```

### Frontend
```bash
cd frontend

# Install dependencies
npm install

# Run development server
npm run dev

# Build for production
npm run build

# Start production server
npm start
```

### Shared Types
```bash
cd packages/shared-types

# Build the package
npm run build

# This makes types available to frontend and backend
```

## Important Commands

### Prisma
```bash
# Generate Prisma Client
npx prisma generate

# Create migration
npx prisma migrate dev --name migration_name

# Reset database (dangerous!)
npx prisma migrate reset

# Open Prisma Studio (database GUI)
npx prisma studio
```

### OpenAPI
```bash
# Generate TypeScript types from openapi.yaml
npm run generate-types
```

## Environment Variables

### Backend (.env)
```bash
DATABASE_URL=         # Supabase PostgreSQL connection string
SUPABASE_URL=         # Supabase project URL
SUPABASE_ANON_KEY=    # Supabase anonymous key
SUPABASE_SERVICE_KEY= # Supabase service role key (backend only)
PORT=3001             # Backend server port
NODE_ENV=development  # Environment
```

### Frontend (.env.local)
```bash
NEXT_PUBLIC_SUPABASE_URL=      # Supabase project URL
NEXT_PUBLIC_SUPABASE_ANON_KEY= # Supabase anonymous key
NEXT_PUBLIC_API_URL=           # Backend API URL
```

## Authentication & Authorization

- **Authentication**: Handled by Supabase Auth
- **Session Management**: JWT tokens from Supabase
- **Authorization**: Role-based access control (RBAC)
  - `admin`: Full system access
  - `teacher`: Can supervise/review theses
  - `student`: Can view assigned theses
- **Row Level Security (RLS)**: Enabled on Supabase tables

## Internationalization (i18n)

- **Library**: next-intl
- **Languages**: Czech (cz), English (en)
- **Translation Files**: `frontend/src/locales/{locale}/common.json`
- **Usage**: Server and client components support translations

## Key Workflows

### Creating a New Feature

1. **Define Types** in `packages/shared-types/src/`
2. **Update Prisma Schema** if database changes needed
3. **Create Migration**: `npx prisma migrate dev`
4. **Create Service** in `backend/src/services/`
5. **Create Controller** in `backend/src/controllers/`
6. **Add Routes** in `backend/src/routes/`
7. **Create Frontend Components** in `frontend/src/components/`
8. **Add i18n Translations** in locale files

### When Types Don't Match

If you see type errors:

1. ✅ **Check**: Are you using `@sumbi/shared-types` in controllers?
2. ✅ **Check**: Have you rebuilt the shared-types package?
3. ✅ **Check**: Are field names correct (e.g., `main_documentation` not `main_document`)?
4. ✅ **Check**: Are ID types correct (BigInt vs UUID string)?
5. ❌ **Don't**: Import Prisma types directly in controllers
6. ❌ **Don't**: Use OpenAPI generated types in backend code

## Common Issues & Solutions

### Issue: Types not found from `@sumbi/shared-types`
**Solution**:
```bash
cd packages/shared-types
npm run build
```

### Issue: Prisma Client out of sync
**Solution**:
```bash
npx prisma generate
```

### Issue: OpenAPI types outdated
**Solution**:
```bash
npm run generate-types
```

### Issue: BigInt serialization errors
**Solution**: Already handled in controllers with:
```typescript
BigInt.prototype.toJSON = function () {
  return Number(this);
};
```

## Additional Resources

- **Prisma Docs**: https://www.prisma.io/docs
- **Supabase Docs**: https://supabase.com/docs
- **Next.js Docs**: https://nextjs.org/docs
- **Express Docs**: https://expressjs.com/
- **OpenAPI Spec**: https://swagger.io/specification/

## Notes for AI/Development

- Always use shared types from `@sumbi/shared-types` in API layers
- Prisma types are internal to the service layer only
- Use `as any` type assertions when returning Prisma results as shared types (acceptable pattern)
- Student IDs are UUID strings, not BigInts
- Project IDs are BigInts (but converted to numbers for Prisma)
- Add JSDoc comments to all public functions
- Follow the existing controller/service pattern consistently
